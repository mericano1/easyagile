<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>Backlog</title>
		<link type="text/css" href="css/ui-lightness/jquery-ui-1.8.11.custom.css" rel="stylesheet" />	
		<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.8.11.custom.min.js"></script>
		<script type="text/javascript">
			(function () {
				/*
				
				Arguments: 
					stories 	-> Array of objects [ {name:string, description:string, points:integer} ]
				
				*/
				$.fn.backlogBoard = function(){
					var args = Array.prototype.slice.call(arguments);
					var data = null;
					var self = this;
					self.append($("<div class='left-panel'/>")).append($("<div class='right-panel'/>"));
					if (args.length == 1 && typeof(args[0]) == "object") {
						loadData(args[0]);
						_init.call(this);
					}
					
					function loadData(prmdata){
					        data = prmdata;
					        $(data).each(function(index,story){
					                if (story.tasks && story.tasks.length > 0){
					                        var totalPoints = 0;
					                        $(story.tasks).each(function(index, task) {totalPoints +=task.points});
					                        story.points = totalPoints;
					                }
					        });
					        
					}
										
					function getStory(object){
						var getByProperty = function (name, value){
							for(var i in data){
								if (data[i][name] == value){
									return data[i];
								}
							}
						}
						if (object.index){
							return getByProperty("index", object.index);
						}
						if (object.name){
							return getByProperty("name", object.name);
						}
						
					}
					
					function deleteStory(story){
						data.splice(story.index, 1);
						var storyDiv=story.div;
						storyDiv.remove();
						printData();
					}
					
					function printData(){
						var text = "";
						$(data).each(function(index, story){
								text+="[index:" + story.index 
									+ ",name:" + story.name
									+ ",desc:" + story.description
									+ ",points:" + story.points
									+ "]<br/>";
							});
						$("#data").html(text);
					}
					
					
					function addStory(story, block, index){
						if (index == 'undefined') {index = data.length;}
						if (!block) {
							block = $(self).first();
						}
						story.index = index;
						var storyDiv = $("<div class=\"ui-widget storySummary\">").append(
							"<div class=\"ui-state-highlight ui-corner-all\" style=\"padding: 0 .7em;\">" + 
							"<p><span class=\"ui-icon ui-icon-info\" style=\"float: left; margin-right: .3em;\"></span>" +
							"<span class=\"ui-icon ui-icon-triangle-1-e\" title=\"Show tasks\"style=\"float: right; margin-left: .3em;\"></span>" + 
							"<span class=\"ui-icon ui-icon-trash\" title=\"delete\" style=\"float: right; margin-left: .3em;\"></span>" + 
							"<span class=\"ui-icon ui-icon-pencil\" title=\"edit\"style=\"float: right; margin-left: .3em;\"></span>" + 
							
							"<strong class=\"story-name\" style=\"display:block\">"+ story.name +"</strong>" +
							"<span class=\"story-description\">" + story.description +"</span>" +
							 "</p>" +
							 "<div class=\"card-info\"><span class=\"priority\">" + (index + 1) + "</span>" +
							 "<span class=\"points\">" + story.points + "</span>" + 
							 "<div style=\"clear:both;\"/>" + 
							 "</div>" +
							"</div>" +
							"</div>").data("story", story);
						$(block).append(storyDiv);
						story.setDisplayPoints = function(points) {
							$(".points",storyDiv).text(points);
						};
						
						story.setDisplayName = function(name) {
							$(".story-name",storyDiv).text(name);
						};
						
						story.setDisplayDescription = function(description) {
							$(".story-description",storyDiv).text(description);
						};
						
						story.setDisplayPriority = function(priority) {
							$(".priority",storyDiv).text(priority);
						};
						
						$(".ui-icon-trash",storyDiv).button().click(function(){deleteStory(storyDiv.data("story"));});
						$(".ui-icon-pencil",storyDiv).button().click(function(){
							displayStoryForm(story);
						});
						$(".ui-icon-triangle-1-e",storyDiv).button().click(function(){
						        var taskListDiv = $(".right-panel",block.parent());
						        taskListDiv.html("");
							$(story.tasks).each(function(index, task){
							        addStory(task,taskListDiv,index);
							
							});
							makeElementsSortable(taskListDiv);
							taskListDiv.toggle(500);
						});
						story.div = storyDiv;
						printData();
					}
					
					function _init() {
						$(self).each (function () {
						        //styling the two blocks
							var block = $(this).children(".left-panel");
							$(block).css("width", "49.5%")
							        .css("display", "inline-block")
							        .css("vertical-align", "top");
							//$(block).css("padding", "0 5px");
							
							var leftBlock = $(this).children(".right-panel");
							$(leftBlock).css("width", "49.5%")
							        .css("display", "inline-block")
							        .css("vertical-align", "top")
							        .css("float", "right");
							//$(leftBlock).css("padding", "0 5px");
							
							$(data).each(function(index, story){
								addStory(story,block,index);
							});
							makeElementsSortable(block);
							
						});
						
						initialized = true;
					}
					
					function makeElementsSortable(block){
					        $(block).sortable({
							stop: function(event, ui) {
								var item = ui.item;
								var newIndex = $(item).parent().children().index(item);
								var story = item.data("story");
								var prevIndex = story.index;
								//update story indexes
								if (prevIndex == newIndex){return;}
								if (prevIndex > newIndex ) { //drag up
									for (i=newIndex; i < prevIndex; i++){
										data[i].index++;
										currentDiv = data[i].div;
										$(".priority", currentDiv).text(data[i].index + 1);
									}
								}
								//prevIndex is still the moved object
								if (prevIndex < newIndex ) { //drag down
									for (i= (prevIndex + 1); i <= newIndex; i++){
										data[i].index--;
										currentDiv = data[i].div;
										$(".priority", currentDiv).text(data[i].index + 1);
									}
								}
								story.index = newIndex;
								sortData();
								story.setDisplayPriority(newIndex + 1);
								printData();
							}
						});
					}
					
					return {
						addStory: addStoryAndUpdateData,
						getStory: getStory,
						deleteStory: deleteStory,
						showStoryDialog: displayStoryForm,
						editStory: editStory
					}
					
					function editStory(index, story){
						previousStory = data[index];
						previousStory.name = story.name;
						previousStory.description = story.description;
						previousStory.points = story.points;
						previousStory.setDisplayPoints(story.points);
						previousStory.setDisplayDescription(story.description);
						previousStory.setDisplayName(story.name);
						printData();
						
					}
					
					function addStoryAndUpdateData(story){
						index = data.length;
						data.push(story);
						return addStory(story, $(self).first(), index);
					}
					
					//sorts the data array
					function sortData(){
						data.sort(function (a,b) {
							return  (a.index < b.index) ? -1 : (a.index > b.index) ? 1 : 0;
						});
					}
					
					//display the dialog. If story is null an empty form will show.
					function displayStoryForm(story){
						var form = null;
						if ($("#dialog-form").length == 0){
							form = $(getFormHtml());
							$(document).append(form);
						}else {
							form = $("#dialog-form");
						}
						
						var name = $( "#name", form ),
						description = $( "#description", form  ),
						points = $( "#points", form ),
						allFields = $( [] ).add( name ).add( description ).add( points );
						if (story){
							name.val(story.name);
							description.val(story.description);
							points.val(story.points);
						}
						$(form).dialog({
							autoOpen: true,
							height: 380,
							width: 350,
							modal: true,
							resizable: false,
							buttons: {
								Save: function() {
									allFields.removeClass( "ui-state-error" );
									if (isNaN(points.val())){
										points.addClass( "ui-state-error" );
									} else {
										if(story){//edit
											editStory(story.index, {name:name.val() ,description: description.val(), points:points.val()});
										} else {//add
											addStoryAndUpdateData({name:name.val() ,description: description.val(), points:points.val()});
										}
										$( this ).dialog( "close" );
									}
								},
								Cancel: function() {
									allFields.removeClass( "ui-state-error" );
									$( this ).dialog( "close" );
								}
								
							}
						});
						
					}
					
					function getFormHtml(object){
						return "<div id=\"dialog-form\" title=\"Story details\"> " +
							"<p class=\"validateTips\">All form fields are required.</p>" + 
							"<form>" + 
							"<fieldset>" + 
								"<label for=\"name\">Name</label>" + 
								"<input type=\"text\" name=\"name\" id=\"name\" class=\"text ui-widget-content ui-corner-all\" />" + 
								"<label for=\"description\">Description</label>" + 
								"<textarea name=\"description\" id=\"description\" value=\"\" class=\"text ui-widget-content ui-corner-all\" ></textarea>" + 
								"<label for=\"points\">Points</label>" + 
								"<input type=\"points\" name=\"points\" id=\"points\" value=\"\" class=\"text ui-widget-content ui-corner-all\" />" + 
							"</fieldset>" + 
							"</form>" + 
						"</div>";
					}
					
				}
				
				
			})(jQuery);
			
			
			
			var stories = [
					{name:"Story 1", description:"Story one short description", points:12, tasks:[
						{name:"task1", description:"task1 story1", points:12},
						{name:"task2", description:"task2 story1", points:4}
					]} ,
					{name:"Story 2", description:"Story two short description", points:2, tasks:[
						{name:"task56", description:"task1 story2", points:8},
						{name:"task34", description:"task2 story2", points:9},
						{name:"task4", description:"task2 story3", points:6}
					]} ,
					{name:"Story 3", description:"Story three short description", points:3} ,
					{name:"Story 4", description:"Story four short description", points:5} ,
					{name:"Story 5", description:"Story five short description", points:7} ,
					{name:"Story 6", description:"Story six short description", points:3} ,
					{name:"Story 7", description:"Story seven short description", points:8} 
				];
			$(document).ready(function() {
				var board = $(".backlogWrapper").backlogBoard(stories);
				$("#addStory").button(/*{icons: {primary: "ui-icon-plusthick"}}*/).click(function() {
					board.showStoryDialog();
				});
				
				
					
			});
		</script>
		<style type="text/css">
			/*demo page css*/
			body{ font: 62.5% "Trebuchet MS", sans-serif; margin: 50px;}
			.demoHeaders { margin-top: 2em; }
			#dialog_link {padding: .4em 1em .4em 20px;text-decoration: none;position: relative;}
			#dialog_link span.ui-icon {margin: 0 5px 0 0;position: absolute;left: .2em;top: 50%;margin-top: -8px;}
			ul#icons {margin: 0; padding: 0;}
			ul#icons li {margin: 2px; position: relative; padding: 4px 0; cursor: pointer; float: left;  list-style: none;}
			ul#icons span.ui-icon {float: left; margin: 0 4px;}
			.ui-icon{
				cursor: pointer;
			}
			
			.storySummary {
				margin:5px 0;
				cursor:move;
			}
			.card-info span.priority {
				float:left;
			}
			.card-info span.points {
				float:right;
			}
			label, input, textarea { display:block; }
			input.text, textarea { margin-bottom:12px; width:95%; padding: .4em; }
			fieldset { padding:0; border:0; margin-top:25px; }
			
		</style>	
	</head>
	<body>
		
			
		<!-- Highlight / Error -->
		<h2 class="demoHeaders">Backlog</h2>
		<div class="headerButtons">
		        <button id="addStory">Add Story</button>
		</div>
		<div class="backlogWrapper">
		</div>
		
		<div id="data">
		</div>
		


	</body>
</html>


