<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>Backlog</title>
		<link type="text/css" href="@{'/public/stylesheets/ui-lightness/jquery-ui-1.8.11.custom.css'}" rel="stylesheet" />	
		<link type="text/css" href="@{'/public/stylesheets/main.css'}" rel="stylesheet" />
		<script type="text/javascript" src="@{'/public/javascripts/jquery-1.6.min.js'}"></script>
		<script type="text/javascript" src="@{'/public/javascripts/jquery-ui-1.8.11.custom.min.js'}"></script>
		<script type="text/javascript" src="@{'/public/javascripts/underscore.js'}"></script>
		<script type="text/javascript" src="@{'/public/javascripts/backbone.js'}"></script>
		<script type="text/javascript" src="@{'/public/javascripts/modelBB.js'}"></script>
		<script type="text/javascript">
		
			//function to get url variables
			$.extend({
				getUrlVars: function(){
				    var vars = [], hash;
				    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
				    for(var i = 0; i < hashes.length; i++)
				    {
				      hash = hashes[i].split('=');
				      vars.push(hash[0]);
				      vars[hash[0]] = hash[1];
				    }
				    return vars;
				  },
				  getUrlVar: function(name){
				    return $.getUrlVars()[name];
				  }
				});			
			/*
			*
			********************************************************************************
			
				Sprints plugin
			
			********************************************************************************
			*
			*/
			(function(){
				var storiesBySprintUrl = #{jsAction @Stories.bySprint(':sprintId') /}
				var tasksByStory = #{jsAction @Tasks.byStory(':storyId') /}
				$.fn.sprintLine = function(){
					var settings = {
						sprintsUrl:"@{Sprints.all}",
						tasksUrl: tasksByStory,
                        usersUrl: "@{Users.all()}",
                        storiesBySprintUrl: storiesBySprintUrl,
                        storiesUnassigned: "@{Stories.unassigned()}",
                        saveSessionUrl:"@{Stories.save()}",
                        sprintSaveUrl:"@{Sprints.save()}",
                        dateFormat: "dd-mm-yy"
					}
					var self = this;
					var sprints = null;
					var currentBacklogBoard = null;
					
					
					
					
					/**
					* This class represents a sprint block
					* @info : Object with sprint info
					*/
					function SprintBlock(info, container){
						
						
						
						// Event handler on drop
						function onBlockDrop(event,ui){
				            storyOrTask = $(ui.draggable).data('storyOrTask');
				            sprint = this.info;
				            block = this;
				            if (!this.isCurrentSprint()){
				            	$(getAssignToSprintConfirmationForm()).dialog({
				            		resizable: false,
				        			height:140,
				        			modal: true,
				        			autoOpen:true,
				        			buttons: {
				        				"Yes move it": function() {
				        					$.post("@{Stories.assignStory}", {
				        						json:storyOrTask.toJson(), 
				        						sprintId: (sprint!=null)? sprint.id: null
				        					})
							            	.success(function(){
							            		currentBacklogBoard = block.getCurrentSprintBoard();
							            		data = currentBacklogBoard.getData();
							            		data.splice(storyOrTask.index, 1);
							            		storyOrTask.div.remove();
							            	})
							            	.error(function(){
							            		alert("mannaggia!");
							            	});
				        					$( this ).dialog( "close" );
				        				},
				        				Cancel: function() {
				        					$( this ).dialog( "close" );
				        				}
				        			}

				            	});
				            }
				        }
						
						
						
					}// ---------- End SprintBlock class --------------
					
					
					
					var sprints = loadSprints();
					
					function loadSprints(){
						var sprintId = $.getUrlVar("sprintId");
						if (sprintId == undefined || sprintId == null || isNaN(sprintId)){
							sprintId = 0;
						}
						
						$.extend(Statics.settings, settings);
						Statics.settings.backlogEl = $('.backlogWrapper');

						sprintList = new SprintList;
						sprintList.url = settings.sprintsUrl;
						var sprintContainer = new SprintListView({
								collection: sprintList,
								el:  $(".sprintWrapper")
							});
						sprintList.fetch();
						
						var users = new UserList;
						users.url = settings.usersUrl;
						var team = new TeamView({
							users : users
						});
						Statics.team = team;
						return sprintContainer;
						
					}
					
					
					
					
					return sprints;
				}
			})(jQuery);
			
			
			$(document).ready(function() {
				var sprints = $(".sprintWrapper").sprintLine();
				$("#addSprint").button().click(function(){
					view = new SprintFormView({onSave: function(toAdd){
						var addedSprint = sprints.collection._add(toAdd);
						addedSprint.save();
					}});
					view.display();
				});
			});
		</script>
	</head>
	<body>
		
			
		<!-- Highlight / Error -->
		<div class="sprintContainer">
			<h2 >Sprints <button id="addSprint">Add Sprint</button></h2>
			<div class="sprintWrapper">
	        </div>
		</div>
		
		<div class="backlogWrapper">
		</div>
		
		
		<button style= "display: block;clear:both; margin-top:250px;" id="showDataButton">Show data</button>
		<div id="data" style="display: none;" class="formitem">
		    <label for="rules" id="ruleslabel">Data:</label>
		    <div class="textwrapper">
		    	<textarea class="data-textArea"cols="2" rows="10" id="data-textArea"></textarea>
		    </div>
		</div>
		<script>
			$('#showDataButton').button().click(function (){
				if ($("#data").is(":visible")){
	                $("#showDataButton").empty().append("Show data");
	            }else{
	            	$("#data-textArea").val($(".sprintWrapper").data("sprintBoard").getDataJson());
	            	$("#showDataButton").empty().append("Hide data");
	            }
				$('#data').toggle();
			})
		</script>


	</body>
</html>


