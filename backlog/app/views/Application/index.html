<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
		<title>Backlog</title>
		<link type="text/css" href="@{'/public/stylesheets/ui-lightness/jquery-ui-1.8.11.custom.css'}" rel="stylesheet" />	
		<script type="text/javascript" src="@{'/public/javascripts/jquery-1.5.1.min.js'}"></script>
		<script type="text/javascript" src="@{'/public/javascripts/jquery-ui-1.8.11.custom.min.js'}"></script>
		<script type="text/javascript">
			(function () {
				
				/*
				
				Arguments: 
					backlogBoard([stories])  
							stories 	-> Array of objects [{name:string, description:string, id:integer, points:integer, tasks:[tasks]}]
							tasks		-> Array of objects [{name:string, description:string, id:integer, points:integer}]
					
					backlogBoard(url, options)
					        url: String -> The get stories url,
					        options: Object {
					        	tasksUrl: String -> The url to retrieve tasks. If null assumes the story url retrieved everything,
					        	usersUrl: String -> The url to retrieve users. If null shows the no user available,
					        }
					        
		        */
				$.fn.backlogBoard = function(){
					var args = Array.prototype.slice.call(arguments);
					var data = null;
					var self = this;
					var header = null;
					var leftPanel = null;
					var rightPanel = null;
					var users = null;
					
					//default settings
					var settings = {
						convertJsonFields : ["id", "name", "description", "points", "index", "tasks", "deleted", "completed","assignee"]
					};
					
					if (args.length == 1 && typeof(args[0]) == "object") {
						loadData(args[0]);
						_init.call(this);
					}

					//url load
					if (typeof(args[0]) == "string") {
						$.getJSON(args[0], function (data) { 
							loadData(data);
							_init.call(this);
						});
						if(args.length == 2){
							settings = jQuery.extend(true, settings, args[1]);
						}
					}
					
					
					function _init() {
						(function addHtmlToElement(element){
							header = $("<div class='headerButtons'>");
							header.append($("<button id='addStory'>Add Story</button>"));					
							header.append($("<button id='saveStories'>Save Session</button>"));
							
							leftPanel = $("<div class='left-panel'/>");
							rightPanel = $("<div class='right-panel'/>");
							self.append(header).append(leftPanel).append(rightPanel);
							
							//addBusyLoadingElement();
							var winH = $(window).height();
							var winW = $(window).width();
							$('body').append('<div id="ajaxBusy"><p><img src="@{'/public/images/loading.gif'}"></p></div>');
							$('#ajaxBusy').css({
							  display:"none",
							  top:winH/2,
							  left:winW/2,
							  width:"auto",
							  position:"absolute" 
							});
							
							//main header buttons
							$("#addStory").button().click(function() {
								displayStoryOrTaskForm();
							});
							$("#saveStories").button().click(function(){
				                $.post("@{Stories.save()}",{json: JSON.stringify(data, settings.convertJsonFields)});
							});
						})($(this));
						
						$(self).each (function () {
					        //styling the two blocks
						var block = $(self).children(".left-panel");
						$(block).css("width", "49.5%")
						        .css("display", "inline-block")
						        .css("vertical-align", "top")
						        .css("float", "left");;
						//$(block).css("padding", "0 5px");
						
						var leftBlock = $(self).children(".right-panel");
						$(leftBlock).css("width", "49.5%")
						        .css("display", "inline-block")
						        .css("vertical-align", "top")
						        .css("float", "right");
						//$(leftBlock).css("padding", "0 5px");
						
						$(data).each(function(index, story){
							addStoryOrTask(story,block,index);
						});
						makeElementsSortable(block, data, clearRightPanel);
						
					});
						
						// Setup the ajax indicator
						$(document).ajaxStart(function(){
				        	$('#ajaxBusy').show();
				        }).ajaxStop(function(){
							$('#ajaxBusy').hide();
				        });
						
						initialized = true;
					}
					
					
					
					
					function loadData(prmdata){
					        data = prmdata;
					        $(data).each(function(index, story){
					                if (story.tasks && story.tasks.length > 0){
					                        var totalPoints = 0;
					                        $(story.tasks).each(function(index, task) {totalPoints +=task.points});
					                        story.points = totalPoints;
					                }
					        });
					        
					}
										
					function getStory(object){
						var getByProperty = function (name, value){
							for(var i in data){
								if (data[i][name] == value){
									return data[i];
								}
							}
						}
						if (object.id){
                            return getByProperty("id", object.id);
                        }
						if (object.index){
							return getByProperty("index", object.index);
						}
						if (object.name){
							return getByProperty("name", object.name);
						}
					}
					
					function showUsers(storyOrTaskDiv){
						if (users == null && settings.usersUrl != undefined){
							$.ajax(settings.usersUrl, //+ user.team.id?,
                                    { async:false,
							          dataType: 'json',
                                      success: function (data) {
                                           users = data;
                                      }
                            });
						}
						select = $("<select/>");
                        $(users).each(function(index, value){
                            display = value.name?value.name:value.email;
                            id = value.email;
                            select.append($("<option/>").attr("name", id ).attr("value", display).text(display));
                        });
                        $("<div/>").append(select).dialog({
                                autoOpen: true,
                                height: 150,
                                width: 250,
                                modal: true,
                                resizable: false,
                                buttons: {
                                     Assign: function(){
                                         storyOrTask = storyOrTaskDiv.data("storyOrTask");
                                         storyOrTask.assignee = select.val();
                                         storyOrTask.setDisplayAssignee(select.val());
                                         printData();
                                         $( this ).dialog( "close" );
                                     },
                                     Cancel: function() {
                                            $( this ).dialog( "close" );
                                     }
                                    }
                                }
                        );
						
					}
					
					function deleteStoryOrTask(storyOrTask, dataSet){
						if (!dataSet) {dataSet = data;}
						dataSet[storyOrTask.index].deleted = true;
						var storyDiv=storyOrTask.div;
						storyDiv.remove();
						printData();
					}
					
					function printData(){
						var getItemText = function(element){
							var text = "";
							$(element).each(function(index, storyOrTask){
								text +=JSON.stringify(storyOrTask, settings.convertJsonFields) 
								+ (storyOrTask.tasks? "=><br/>" + getItemText(storyOrTask.tasks) : "")
									+ "<br/>" ;
							});
							return text;
						};
						
						$("#data").html(getItemText(data));
					}
					
					
					function addStoryOrTask(storyOrTask, block, index, isTask, parentStory){
						if (index == 'undefined') {index = data.length;}
						if (!block) {
							block = $(self).first();
						}
						storyOrTask.index = index;
						var storyOrTaskDiv = $(storyOrTaskHtml(storyOrTask, index, isTask)).data("storyOrTask", storyOrTask);
						
						$(block).append(storyOrTaskDiv);
						storyOrTask.setDisplayPoints = function(points) {
							$(".points",storyOrTaskDiv).text(points);
						};
						
						storyOrTask.setDisplayName = function(name) {
							$(".storyOrTask-name",storyOrTaskDiv).text(name);
						};
						
						storyOrTask.setDisplayDescription = function(description) {
							$(".storyOrTask-description",storyOrTaskDiv).text(description);
						};
						
						storyOrTask.setDisplayAssignee = function(assignee) {
                            $(".assignee",storyOrTaskDiv).text(assignee);
                        };
                        
						storyOrTask.setDisplayPriority = function(priority) {
							$(".priority",storyOrTaskDiv).text(priority);
						};
						
						//Bind storyOrTask buttons
						$(".ui-icon-trash",storyOrTaskDiv).button().click(function(){deleteStoryOrTask(storyOrTaskDiv.data("storyOrTask"), (isTask ? parentStory.tasks : null));});
						$(".ui-icon-pencil",storyOrTaskDiv).button().click(function(){displayStoryOrTaskForm(storyOrTask, isTask);});
						if (!isTask){
							$(".ui-icon-triangle-1-e",storyOrTaskDiv).button().click(function(){showStoryTasks(storyOrTask)});
							$(".ui-icon-plusthick",storyOrTaskDiv).button().click(function(){displayStoryOrTaskForm.call(storyOrTask, null, true)});
						}else {
							$(".ui-icon-check",storyOrTaskDiv).button().click(function(){toggleStoryOrTaskCompleted(storyOrTask)});
							$(".user",storyOrTaskDiv).button().click(function(){showUsers(storyOrTaskDiv);});
						}
						storyOrTask.div = storyOrTaskDiv;
						printData();
					}
					
					function toggleStoryOrTaskCompleted(storyOrTask, isTask){
						if(storyOrTask.completed){
							  storyOrTask.completed = false;
							  $(".taskSummary-completed", storyOrTask.div).switchClass("taskSummary-completed","taskSummary");
						}else{
							 storyOrTask.completed = true;
                             $(".taskSummary", storyOrTask.div).switchClass("taskSummary","taskSummary-completed");
						}
						printData();
					}
					
					function showStoryTasks(story, toggle){
						if (toggle == undefined){toggle = true;}
						if (rightPanel.data("storyId") == story.index && toggle){//just hide it
							rightPanel.toggle();
							//$(".ui-icon-triangle-1-e", story.div).switchClass("ui-icon-triangle-1-e", "ui-icon-triangle-1-w");
						} else { //populates it
							clearRightPanel();
						
							//load tasks, the first time it is called
							if (story.tasks == undefined && story.id != undefined && settings.tasksUrl != undefined){ 
								$.ajax(settings.tasksUrl + story.id,
										{ async: false,
								          dataType: 'json',
										  success: function (data) {
											   story.tasks = data;
										  }
								});
							}
							if (story.tasks && story.tasks.length > 0){
								$(story.tasks).each(function(index, task){
										addStoryOrTask(task,rightPanel,index, true, story);
								});
							} else {
								rightPanel.append(noTasksHtml());
							}
							makeElementsSortable(rightPanel, story.tasks);
							
						}
						updateStoryPoints(story);
						rightPanel.data("storyId",story.index);
					}
					
					/**
					* Clears the task panel and returns it
					*/
					function clearRightPanel(){
						rightPanel.html("").css("display","block");
						return rightPanel;
					}
					
					
					
					function makeElementsSortable(block, dataSet, onStart){
					        $(block).sortable({
							stop: function(event, ui) {
								var item = ui.item;
								var newIndex = $(item).parent().children().index(item);
								var storyOrTask = item.data("storyOrTask");
								var prevIndex = storyOrTask.index;
								//update storyOrTask indexes
								if (prevIndex == newIndex){return;}
								if (prevIndex > newIndex ) { //drag up
									for (i=newIndex; i < prevIndex; i++){
										dataSet[i].index++;
										currentDiv = dataSet[i].div;
										$(".priority", currentDiv).text(dataSet[i].index + 1);
									}
								}
								//prevIndex is still the moved object
								if (prevIndex < newIndex ) { //drag down
									for (i= (prevIndex + 1); i <= newIndex; i++){
										dataSet[i].index--;
										currentDiv = dataSet[i].div;
										$(".priority", currentDiv).text(dataSet[i].index + 1);
									}
								}
								storyOrTask.index = newIndex;
								sortData();
								storyOrTask.setDisplayPriority(newIndex + 1);
								printData();
							},
							start: function(event, ui){
								if (onStart) { onStart();}
							}
						});
					}
					
					
					
					function editStoryOrTask(curStoryOrTask, storyOrTask){
						curStoryOrTask.name = storyOrTask.name;
						curStoryOrTask.description = storyOrTask.description;
						curStoryOrTask.points = storyOrTask.points;
						curStoryOrTask.setDisplayPoints(storyOrTask.points);
						curStoryOrTask.setDisplayDescription(storyOrTask.description);
						curStoryOrTask.setDisplayName(storyOrTask.name);
						printData();
						
					}
					
					function addStoryAndUpdateData(story){
						index = data.length;
						data.push(story);
						return addStoryOrTask(story, leftPanel, index);
					}
					
					function addTaskToStory(story, task){
						dataStory = getStory(story);
						showStoryTasks(story, false);
						if (dataStory.tasks == undefined){
							dataStory.tasks = [];
						}
						index = dataStory.tasks.length;
						if (index == 0){
							clearRightPanel();
						}
						dataStory.tasks.push(task);
						updateStoryPoints(dataStory);
                        return addStoryOrTask(task, rightPanel, index, true, story);
					}
					
					function updateStoryPoints(story){
						points = 0;
						$(story.tasks).each(function(index, value){
							points +=parseInt(value.points);
						});
		                story.points = points;
		                story.setDisplayPoints(points);
					}
					
					//sorts the data array
					function sortData(){
						var sortFunction = function (a,b) {
							if (a.tasks) {a.tasks.sort(sortFunction);}
							return  (a.index < b.index) ? -1 : (a.index > b.index) ? 1 : 0;
						};
						data.sort(sortFunction);
					}
					
					//display the dialog. If storyOrTask is null an empty form will show.
					function displayStoryOrTaskForm(storyOrTask, isTask){
						var callingElement = this;
						var form = null;
						var formId = "#dialog-form" + storyOrTaskReturn("-story","-task", isTask);
						if ($(formId).length == 0){
							form = $(getFormHtml(isTask));
							$(document).append(form);
						}else {
							form = $(formId);
						}
						
						var name = $( "#name", form ),
						description = $( "#description", form  ),
						points = $( "#points", form ),
						allFields = $( [] ).add( name ).add( description ).add( points );
						if (storyOrTask){
							name.val(storyOrTask.name);
							description.val(storyOrTask.description);
							points.val(storyOrTask.points);
						} else {
							name.val("");
                            description.val("");
                            points.val("");
						}
						$(form).dialog({
							autoOpen: true,
							height: 380,
							width: 350,
							modal: true,
							resizable: false,
							buttons: {
								Save: function() {
									allFields.removeClass( "ui-state-error" );
									if (isNaN(points.val())){
										points.addClass( "ui-state-error" );
									} else {
										if(storyOrTask){//edit
											editStoryOrTask(storyOrTask, {name:name.val() ,description: description.val(), points:points.val()});
										} else {//add
											if (isTask){
												addTaskToStory(callingElement, {name:name.val() ,description: description.val(), points:points.val()});	
											}else {
											    addStoryAndUpdateData({name:name.val() ,description: description.val(), points:points.val()});
											}
										}
										$( this ).dialog( "close" );
									}
								},
								Cancel: function() {
									allFields.removeClass( "ui-state-error" );
									$( this ).dialog( "close" );
								}
								
							}
						});
						
					}
					
					function getFormHtml(isTask){
						/* $("div",{
							title: storyOrTaskReturn("Story","Task", isTask) + "details"
							
						}); */
						return "<div id=\"dialog-form" + storyOrTaskReturn("-story","-task", isTask)+ "\" title=\"" + storyOrTaskReturn("Story","Task", isTask)+ " details\"> " +
							"<p class=\"validateTips\">All form fields are required.</p>" + 
							"<form>" + 
							"<fieldset>" + 
								"<label for=\"name\">Name</label>" + 
								"<input type=\"text\" name=\"name\" id=\"name\" class=\"text ui-widget-content ui-corner-all\" />" + 
								"<label for=\"description\">Description</label>" + 
								"<textarea name=\"description\" id=\"description\" value=\"\" class=\"text ui-widget-content ui-corner-all\" ></textarea>" + 
								"<label for=\"points\">Points</label>" + 
								"<input type=\"points\" name=\"points\" id=\"points\" value=\"\" class=\"text ui-widget-content ui-corner-all\" />" + 
							"</fieldset>" + 
							"</form>" + 
						"</div>";
					}
					
					function storyOrTaskReturn(storyReturn, taskReturn, isTask){
						if (!isTask){ return storyReturn; }
						else { return taskReturn; }
					}
					
					function storyOrTaskHtml(object, index, isTask){
						taskBgClass = isTask && object.completed ? "taskSummary-completed" : "taskSummary";
						return "<div class=\"ui-widget  storySummary\">" +
						
								"<div class=\"" + storyOrTaskReturn("ui-state-highlight ",taskBgClass, isTask) + " ui-corner-all\" style=\"padding: 0 .7em; \">" + 
									"<p>" +
									"<span class=\"ui-icon ui-icon-info\" style=\"float: left; margin-right: .3em;\"></span>" +
									storyOrTaskReturn("<span class=\"ui-icon ui-icon-triangle-1-e\" title=\"Show tasks\"style=\"float: right; margin-left: .3em;\"></span>", "", isTask) +
									"<span class=\"ui-icon ui-icon-trash\" title=\"delete\" style=\"float: right; margin-left: .3em;\"></span>" + 
									"<span class=\"ui-icon ui-icon-pencil\" title=\"edit\"style=\"float: right; margin-left: .3em;\"></span>" + 
									storyOrTaskReturn("<span class=\"ui-icon ui-icon-plusthick\" title=\"Add task\"style=\"float: right; margin-left: .3em;\"></span>", "", isTask) +
									storyOrTaskReturn("","<span class=\"ui-icon-custom user\" title=\"Assign Task\"style=\"float: right; margin-left: .3em;\"></span>",isTask) +
									storyOrTaskReturn("","<span class=\"ui-icon ui-icon-check \" title=\"Mark Completed\"style=\"float: right; margin-left: .3em;\"></span>",isTask) +
									"<strong class=\"storyOrTask-name\" style=\"display:block\">"+ object.name +"</strong>" +
									"<span class=\"storyOrTask-description\">" + object.description +"</span>" +
									 "</p>" +
									 "<div class=\"card-info\"><span class=\"priority\">" + (isNaN(index)? "" : (index + 1) ) + "</span>" +
									 storyOrTaskReturn("","<span class=\"assignee\">" + ((object.assignee) ? object.assignee : "Not Assigned") + "</span>", isTask) +
									 "<span class=\"points\">" + object.points + "</span>" + 
									 "<div style=\"clear:both;\"/>" + 
									 "</div>" +
									"</div>" +
								"</div>" +
							"</div>";
					}
					
					
					function noTasksHtml(){
						html = $(storyOrTaskHtml({name:"No Tasks are available", description:"Click on \"Add Task\" to add one", points:""},"",true));
						$(".ui-icon, .points, .priority", html).remove();
						return html;
					}
					
					return {
						addStory: addStoryAndUpdateData,
						addTaskToStory: addTaskToStory,
						getStory: getStory,
						deleteStory: deleteStoryOrTask,
						showStoryDialog: displayStoryOrTaskForm,
						editStory: editStoryOrTask,
						getData: function(){return data;}
					}
					
				}
				
				
			})(jQuery);
			
			
			
			$(document).ready(function() {
				// Ajax activity indicator bound to ajax start/stop document events
	            $(".backlogWrapper").backlogBoard("@{Stories.getall()}", 
	            		{
	            	     tasksUrl: "@{Tasks.byStory()}?storyId=",
	            		 usersUrl: "@{Users.getAll()}"
	            		});
				
				
				
					
			});
		</script>
		<style type="text/css">
			/*demo page css*/
			body{ font: 62.5% "Trebuchet MS", sans-serif; margin: 50px;}
			.demoHeaders { margin-top: 2em; }
			#dialog_link {padding: .4em 1em .4em 20px;text-decoration: none;position: relative;}
			#dialog_link span.ui-icon {margin: 0 5px 0 0;position: absolute;left: .2em;top: 50%;margin-top: -8px;}
			ul#icons {margin: 0; padding: 0;}
			ul#icons li {margin: 2px; position: relative; padding: 4px 0; cursor: pointer; float: left;  list-style: none;}
			ul#icons span.ui-icon {float: left; margin: 0 4px;}
			.ui-icon{
				cursor: pointer;
			}
			
			.ui-icon-custom {
			     width: 16px; 
			     height: 16px;
			     cursor: pointer;
			}
			.user {
			     background-image: url(@{'/public/stylesheets/ui-lightness/images/user.png'});
			}
			
			.storySummary {
				margin:5px 0;
				cursor:move;
			}
			
			.taskSummary {
				border: 1px solid #dddddd; background: #eeeeee url(@{'/public/stylesheets/ui-lightness/images/ui-bg-widget_00ffff_1x100.png'}) 50% top repeat-x; color: #333333; 
			}
			
			.taskSummary-completed {
			    border: 1px solid #dddddd; background: #eeeeee url(@{'/public/stylesheets/ui-lightness/images/ui-bg-widget_808000_1x100.png'}) 50% top repeat-x; color: #333333;
			}
			
			.card-info span.priority {
				float:left;
			}
			.card-info span.points {
				float:right;
			}
			.card-info span.assignee {
			     margin-left:15px;
			}
			label, input, textarea { display:block; }
			input.text, textarea { margin-bottom:12px; width:95%; padding: .4em; }
			fieldset { padding:0; border:0; margin-top:25px; }
			
		</style>	
	</head>
	<body>
		
			
		<!-- Highlight / Error -->
		<h2 class="demoHeaders">Backlog</h2>
		
		<div class="backlogWrapper">
		</div>
		
		<div id="data" style="clear:both; margin-top:250px">
		</div>
		


	</body>
</html>


